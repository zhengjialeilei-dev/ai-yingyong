<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨å­¦ç§‘æ•°å­¦ï¼šæ‰‡å½¢ç»Ÿè®¡å›¾å®éªŒå®¤</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å­—ä½“ä¸åŸºç¡€è®¾ç½® */
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden; /* é˜²æ­¢é¡µé¢çº§æ»šåŠ¨ */
            transition: background-color 0.5s ease;
        }

        /* æ¨¡å¼ç‰¹å®šèƒŒæ™¯ */
        body.mode-challenge {
            background-color: #f1f5f9;
        }

        /* --- SVG äº¤äº’æ ·å¼ --- */
        svg { 
            overflow: visible; 
            /* å…³é”®ï¼šè®© SVG è‡ªé€‚åº”å®¹å™¨ */
            width: 100%;
            height: 100%;
            max-width: 600px; /* é™åˆ¶æœ€å¤§å°ºå¯¸ */
            max-height: 600px;
        }
        
        path.sector {
            transition: opacity 0.3s, filter 0.3s;
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
            stroke-linejoin: round;
        }
        path.sector:hover {
            filter: drop-shadow(0px 4px 8px rgba(0,0,0,0.15));
            opacity: 1;
            z-index: 10;
        }

        /* å¹½çµç›®æ ‡å›¾è¡¨æ ·å¼ */
        path.ghost-sector {
            fill: #cbd5e1; /* ç¨å¾®åŠ æ·±ä¸€ç‚¹ç°è‰²ï¼Œä½¿å…¶åœ¨æµ…è‰²èƒŒæ™¯æ›´æ¸…æ™° */
            stroke: #fff;
            stroke-width: 2px;
            opacity: 0.8;
            pointer-events: none;
        }
        
        /* å¹½çµå›¾è¡¨çš„ç›®æ ‡æ ‡ç­¾ */
        text.ghost-label {
            font-size: 12px;
            font-weight: 800;
            fill: #475569; /* Slate-600 */
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
            text-shadow: 0px 1px 0px rgba(255,255,255,0.9);
        }

        /* ä¸»å›¾è¡¨æ ‡ç­¾æ–‡å­— */
        text.label {
            font-size: 14px;
            font-weight: bold;
            fill: white;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
            text-shadow: 0px 1px 2px rgba(0,0,0,0.3);
            transition: opacity 0.2s;
        }

        /* --- UI ç»„ä»¶æ ·å¼ --- */
        
        /* å¼€å…³æ§ä»¶ */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #6366f1;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #6366f1;
        }
        
        /* èƒœåˆ©å¼¹çª—åŠ¨ç”» */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-content {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* ç¤¼èŠ± Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        /* è‡ªå®šä¹‰ Select ä¸‹æ‹‰ç®­å¤´ */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* éšè—æ•°å­—è¾“å…¥æ¡†è‡ªå¸¦çš„ç®­å¤´ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        aside::-webkit-scrollbar {
            width: 6px;
        }
        aside::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        aside::-webkit-scrollbar-track {
            background-color: transparent;
        }
    </style>
</head>
<body class="bg-[#f5f7fa] text-slate-700 h-screen flex flex-col md:flex-row transition-colors duration-500">

    <!-- ç¤¼èŠ±å±‚ -->
    <canvas id="confetti-canvas"></canvas>

    <!-- èƒœåˆ©å¼¹çª— -->
    <div id="win-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm px-4">
        <div class="modal-content bg-white rounded-2xl p-8 w-full max-w-sm text-center shadow-2xl">
            <div class="text-6xl mb-4">ğŸ†</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">æŒ‘æˆ˜æˆåŠŸï¼</h2>
            <p class="text-slate-500 mb-6">ä½ ç ´è§£äº†æ•°æ®çš„ç§˜å¯†ï¼</p>
            <button onclick="nextLevel()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform transition hover:scale-105 active:scale-95">
                ä¸‹ä¸€å…³
            </button>
        </div>
    </div>

    <!-- å·¦ä¾§ï¼šæ§åˆ¶å° (Sidebar) -->
    <aside class="sidebar w-full md:w-80 flex-shrink-0 bg-white shadow-xl z-20 flex flex-col h-[40vh] md:h-full border-r border-transparent transition-colors duration-500">
        
        <!-- Sidebar Header -->
        <header class="p-5 pb-2 flex flex-col gap-3 flex-shrink-0 bg-white/95 backdrop-blur z-10 sticky top-0">
            <!-- åœºæ™¯é€‰æ‹©å™¨ -->
            <div class="relative">
                <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">åŠ è½½ç”Ÿæ´»åœºæ™¯</label>
                <select id="scenario-select" onchange="changeScenario(this.value)" 
                        class="custom-select w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm font-bold rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 cursor-pointer hover:bg-slate-100 transition-colors">
                    <option value="class">ğŸ“Š å…­(1)ç­è¿åŠ¨è°ƒæŸ¥ (4é¡¹)</option>
                    <option value="earth">ğŸŒ åœ°çƒç©ºæ°”æˆåˆ† (3é¡¹)</option>
                    <option value="diet">ğŸ½ï¸ å¥åº·é¥®é£Ÿé¤ç›˜ (3é¡¹)</option>
                    <option value="body">ğŸ’§ äººä½“æˆåˆ†æ­ç§˜ (4é¡¹)</option>
                </select>
            </div>

            <div class="h-px bg-slate-100 w-full"></div>

            <div class="flex items-center justify-between">
                <h1 id="chart-title" class="text-lg font-bold text-slate-800 truncate pr-2">ğŸ“Š å…­(1)ç­è¿åŠ¨è°ƒæŸ¥</h1>
                
                <!-- æ¨¡å¼åˆ‡æ¢å¼€å…³ -->
                <div class="flex items-center gap-1.5 text-xs font-bold flex-shrink-0">
                    <span id="label-free" class="text-indigo-600">æ¢ç´¢</span>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" name="toggle" id="mode-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 top-0 border-slate-300" onclick="toggleMode()"/>
                        <label for="mode-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                    </div>
                    <span id="label-challenge" class="text-slate-400">æŒ‘æˆ˜</span>
                </div>
            </div>
            
            <!-- åŠ¨æ€æç¤ºæ–‡æ¡ˆ -->
            <div id="instruction-box" class="bg-blue-50 text-blue-700 text-xs p-2.5 rounded-lg border border-blue-100 transition-all duration-300">
                è¯•ç€è°ƒæ•´æ•°å­—ï¼Œè§‚å¯Ÿé¥¼å›¾å˜åŒ–ã€‚
            </div>
        </header>

        <!-- æ•°æ®æ§åˆ¶åŒº -->
        <div id="controls-container" class="flex-1 overflow-y-auto px-5 py-2 space-y-3">
            <!-- JS åŠ¨æ€ç”Ÿæˆå¡ç‰‡åˆ—è¡¨ -->
        </div>

        <!-- åº•éƒ¨ç»Ÿè®¡æ¿ -->
        <div class="p-5 pt-2 bg-white flex-shrink-0 border-t border-slate-100">
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 transition-opacity duration-300" id="stats-panel">
                <div class="flex justify-between items-end mb-3">
                    <span class="text-slate-500 font-medium text-xs uppercase tracking-wide">å½“å‰æ€»é‡</span>
                    <span id="total-display" class="text-2xl font-bold text-slate-800 leading-none">0</span>
                </div>
                <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden flex" id="progress-bar">
                    <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§ï¼šå›¾è¡¨åŒº -->
    <main class="flex-1 min-w-0 relative flex flex-col items-center justify-center bg-[#f5f7fa] p-4 md:p-10 transition-colors duration-500" id="main-area">
        
        <!-- è£…é¥°èƒŒæ™¯ -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none overflow-hidden">
             <div class="w-[120%] h-[120%] max-w-[800px] max-h-[800px] border border-slate-300/40 rounded-full opacity-50"></div>
             <div class="absolute w-[80%] h-[80%] max-w-[500px] max-h-[500px] border border-slate-300/30 rounded-full opacity-30 border-dashed"></div>
        </div>

        <!-- SVG ç”»å¸ƒå®¹å™¨ -->
        <svg id="pie-chart" viewBox="-300 -300 600 600" preserveAspectRatio="xMidYMid meet">
            <!-- 1. å¹½çµç›®æ ‡å›¾å±‚ -->
            <g id="ghost-layer" class="opacity-0 transition-opacity duration-500"></g>
            
            <!-- 2. ç”¨æˆ·å›¾è¡¨å›¾å±‚ -->
            <g id="chart-paths" class="chart-group"></g>
            
            <!-- 3. æ–‡å­—æ ‡ç­¾å›¾å±‚ -->
            <g id="chart-labels"></g>
        </svg>

        <!-- æ•™å­¦æç¤º -->
        <div class="absolute bottom-4 right-4 md:bottom-8 md:right-8 bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow-sm border border-slate-200 text-xs text-slate-500">
            ğŸ’¡ ç°è‰²åœ†ç¯ = ç›®æ ‡æ¯”ä¾‹
        </div>
    </main>

    <script>
        // --- 1. è·¨å­¦ç§‘åœºæ™¯æ•°æ®é…ç½® ---
        
        const SCENARIOS = {
            'class': {
                title: "ğŸ“Š å…­(1)ç­è¿åŠ¨è°ƒæŸ¥",
                data: [
                    { name: 'ğŸ€ ç¯®çƒ', val: 15, color: '#FF8080' },
                    { name: 'âš½ è¶³çƒ', val: 10, color: '#87CEFA' },
                    { name: 'ğŸ“ ä¹’ä¹“', val: 8, color: '#76E0AD' },
                    { name: 'ğŸª å…¶ä»–', val: 5, color: '#FCD34D' }
                ]
            },
            'earth': {
                title: "ğŸŒ åœ°çƒç©ºæ°”æˆåˆ†åˆ†æ",
                data: [
                    { name: 'ğŸŒ«ï¸ æ°®æ°”', val: 78, color: '#93C5FD' },
                    { name: 'ğŸ’¨ æ°§æ°”', val: 21, color: '#2563EB' },
                    { name: 'âœ¨ å…¶ä»–', val: 1, color: '#94A3B8' },
                    { name: 'âˆ… æ— ', val: 0, color: '#F1F5F9' } // å ä½ç¬¦ï¼Œä¸å‚ä¸ç”Ÿæˆ
                ]
            },
            'diet': {
                title: "ğŸ½ï¸ å¥åº·é¥®é£Ÿé¤ç›˜",
                data: [
                    { name: 'ğŸ¥¬ è”¬æœ', val: 50, color: '#86EFAC' },
                    { name: 'ğŸŒ¾ è°·è–¯', val: 30, color: '#FDE047' },
                    { name: 'ğŸ¥© è›‹ç™½', val: 20, color: '#FCA5A5' },
                    { name: 'âˆ… æ— ', val: 0, color: '#F1F5F9' }
                ]
            },
            'body': {
                title: "ğŸ’§ äººä½“æˆåˆ†æ­ç§˜",
                data: [
                    { name: 'ğŸ’§ æ°´åˆ†', val: 60, color: '#38BDF8' },
                    { name: 'ğŸ’ª è›‹ç™½', val: 18, color: '#F87171' },
                    { name: 'ğŸ¥“ è„‚è‚ª', val: 16, color: '#FDBA74' },
                    { name: 'ğŸ¦´ ç›ç±»', val: 6, color: '#CBD5E1' }
                ]
            }
        };

        // --- 2. æ ¸å¿ƒçŠ¶æ€ ---
        
        let currentStateKey = 'class';
        let state = []; 
        let gameMode = 'free'; 
        let isWin = false;
        let challengeTarget = []; 

        // --- 3. åœºæ™¯ä¸æ¨¡å¼æ§åˆ¶ ---

        function initApp() {
            changeScenario('class', true);
            animateLoop();
        }

        function changeScenario(key, isFirstLoad = false) {
            currentStateKey = key;
            const scenario = SCENARIOS[key];
            
            state = scenario.data.map((item, index) => ({
                id: `item-${index}`,
                name: item.name,
                color: item.color,
                targetVal: item.val,
                currentVal: isFirstLoad ? item.val : 0
            }));

            document.getElementById('chart-title').textContent = scenario.title;

            // å¦‚æœå¤„äºæŒ‘æˆ˜æ¨¡å¼åˆ‡æ¢åœºæ™¯ï¼Œå¼ºåˆ¶åˆ‡å›æ¢ç´¢æ¨¡å¼
            if (!isFirstLoad && gameMode === 'challenge') {
                document.getElementById('mode-toggle').checked = false;
                toggleMode();
            }

            updateUIForMode();
            triggerAnimation();
        }

        function toggleMode() {
            const checkbox = document.getElementById('mode-toggle');
            gameMode = checkbox.checked ? 'challenge' : 'free';
            
            const body = document.body;
            const instruction = document.getElementById('instruction-box');
            const ghostLayer = document.getElementById('ghost-layer');
            const freeLabel = document.getElementById('label-free');
            const challengeLabel = document.getElementById('label-challenge');
            const select = document.getElementById('scenario-select');

            if (gameMode === 'challenge') {
                body.classList.add('mode-challenge');
                instruction.innerHTML = '<strong>æ•°æ®ä¾¦æ¢ï¼š</strong> åŒ¹é…ç°è‰²åœ†ç¯ä¸Šçš„ <span class="bg-slate-200 px-1 rounded font-bold text-slate-600">ç›®æ ‡ %</span>';
                instruction.className = "bg-indigo-100 text-indigo-800 text-xs p-2.5 rounded-lg border border-indigo-200 shadow-inner";
                ghostLayer.classList.remove('opacity-0');
                
                freeLabel.className = "text-slate-400 transition-colors";
                challengeLabel.className = "text-indigo-600 font-bold transition-colors";
                select.disabled = true;
                select.parentElement.classList.add('opacity-50', 'pointer-events-none');

                nextLevel(); // ç”Ÿæˆæ–°å…³å¡

            } else {
                body.classList.remove('mode-challenge');
                instruction.innerHTML = 'è¯•ç€è°ƒæ•´æ•°å­—ï¼Œè§‚å¯Ÿé¥¼å›¾å˜åŒ–ã€‚';
                instruction.className = "bg-blue-50 text-blue-700 text-xs p-2.5 rounded-lg border border-blue-100";
                ghostLayer.classList.add('opacity-0');
                
                freeLabel.className = "text-indigo-600 font-bold transition-colors";
                challengeLabel.className = "text-slate-400 transition-colors";
                select.disabled = false;
                select.parentElement.classList.remove('opacity-50', 'pointer-events-none');

                changeScenario(currentStateKey);
            }
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€ç”Ÿæˆç›®æ ‡é€»è¾‘ ---
        function nextLevel() {
            isWin = false;
            document.getElementById('win-modal').classList.add('hidden');
            
            // 1. è·å–æœ‰æ•ˆåˆ†ç±» (æ’é™¤ "æ— " å ä½ç¬¦)
            const activeItems = state.filter(s => s.name !== 'âˆ… æ— ');
            const n = activeItems.length; // æœ‰æ•ˆåˆ†ç±»æ•°é‡ (3 æˆ– 4)

            // 2. åŠ¨æ€ç”Ÿæˆæ•´é½çš„éšæœºæ¯”ä¾‹ (5% çš„å€æ•°)
            // åŸç†ï¼šå°† 100% è§†ä¸º 20 ä¸ª 5% çš„ç­¹ç 
            // ç®—æ³•ï¼šn ä¸ªæ•°ä¹‹å’Œä¸º 20ï¼Œä¸”æ¯ä¸ªæ•° >= 1 (ç¡®ä¿ä¸å‡ºç° 0% çš„ç›®æ ‡)
            
            if (n === 0) return;

            let slots = new Array(n).fill(1); // ç»™æ¯ä¸ªåˆ†ç±»å…ˆåˆ† 1 ä¸ªç­¹ç  (5%)
            let remainingChips = 20 - n; // å‰©ä½™ç­¹ç æ•°

            // éšæœºåˆ†é…å‰©ä½™ç­¹ç 
            for (let i = 0; i < remainingChips; i++) {
                const randomIndex = Math.floor(Math.random() * n);
                slots[randomIndex]++;
            }

            // å°†ç­¹ç è½¬æ¢ä¸ºæ¯”ç‡ (0.05, 0.25 ...)
            const ratios = slots.map(chips => chips * 0.05);

            // 3. å°†ç”Ÿæˆçš„æ¯”ç‡åˆ†é…ç»™ Challenge Target
            // éœ€è¦ç»´æŠ¤ä¸€ä¸ª ratio ç´¢å¼•ï¼Œè·³è¿‡ "æ— " å ä½ç¬¦
            let ratioIndex = 0;
            challengeTarget = state.map(item => {
                if (item.name === 'âˆ… æ— ') {
                    return { id: item.id, ratio: 0 };
                } else {
                    const r = ratios[ratioIndex++];
                    return { id: item.id, ratio: r };
                }
            });

            // 4. é‡ç½®ç”¨æˆ·è¾“å…¥ä¸º 1 (é¿å… 0 æ¶ˆå¤±éš¾æ“ä½œ)
            state.forEach(item => {
                if (item.name !== 'âˆ… æ— ') item.targetVal = 1;
                else item.targetVal = 0;
            });
            
            updateUIForMode();
            drawGhostChart();
            triggerAnimation();
        }

        // --- 4. UI æ¸²æŸ“ (å¡ç‰‡å¼å¸ƒå±€) ---

        function updateUIForMode() {
            const container = document.getElementById('controls-container');
            const progressBar = document.getElementById('progress-bar');
            
            container.innerHTML = '';
            progressBar.innerHTML = '';

            state.forEach(item => {
                if (item.name === 'âˆ… æ— ') return;

                // åˆ›å»ºå¡ç‰‡
                const card = document.createElement('div');
                const bgTint = item.color + '20'; 
                card.className = "rounded-xl p-3 border border-transparent transition-all duration-200 hover:shadow-md";
                card.style.backgroundColor = bgTint; 

                const percentDisplay = gameMode === 'challenge' 
                    ? `<span class="text-2xl font-bold text-slate-300">?</span>`
                    : `<span id="percent-${item.id}" class="text-lg font-bold" style="color: ${item.color}">0%</span>`;

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full shadow-sm ring-1 ring-white/50" style="background-color: ${item.color}"></div>
                            <span class="font-bold text-slate-700 text-sm truncate max-w-[120px]" title="${item.name}">${item.name}</span>
                        </div>
                        ${percentDisplay}
                    </div>

                    <div class="flex items-center bg-white/60 rounded-lg p-1 shadow-sm">
                        <button class="btn-action flex-1 h-9 rounded-md bg-white hover:bg-slate-50 text-slate-600 font-bold text-lg transition-colors shadow-sm border border-slate-100 active:scale-95" 
                                onclick="updateValue('${item.id}', -1)">âˆ’</button>
                        
                        <input type="number" 
                               id="input-${item.id}"
                               class="w-14 text-center font-mono font-bold text-lg bg-transparent outline-none text-slate-800" 
                               value="${item.targetVal}" 
                               onchange="updateValue('${item.id}', this.value, true)"
                               min="0">

                        <button class="btn-action flex-1 h-9 rounded-md bg-white hover:bg-slate-50 text-slate-600 font-bold text-lg transition-colors shadow-sm border border-slate-100 active:scale-95" 
                                onclick="updateValue('${item.id}', 1)">+</button>
                    </div>
                `;
                container.appendChild(card);

                // è¿›åº¦æ¡ç‰‡æ®µ
                const barSegment = document.createElement('div');
                barSegment.id = `bar-${item.id}`;
                barSegment.style.backgroundColor = item.color;
                barSegment.style.width = '0%';
                barSegment.style.height = '100%';
                barSegment.style.transition = 'width 0.5s ease';
                if(gameMode === 'challenge') barSegment.style.opacity = '0.5';
                progressBar.appendChild(barSegment);
            });
        }

        function updateValue(id, change, isDirectInput = false) {
            if (isWin && gameMode === 'challenge') return;

            const item = state.find(x => x.id === id);
            if (!item) return;

            let newValue = isDirectInput ? parseInt(change) : item.targetVal + change;
            if (newValue < 0) newValue = 0;
            if (isNaN(newValue)) newValue = 0;

            item.targetVal = newValue;
            const inputEl = document.getElementById(`input-${id}`);
            if (inputEl) inputEl.value = newValue;
            
            triggerAnimation();
        }

        // --- 5. åŠ¨ç”»å¾ªç¯ & åˆ¤å®š ---

        let isAnimating = false;
        function triggerAnimation() {
            if (!isAnimating) {
                isAnimating = true;
                requestAnimationFrame(animateLoop);
            }
        }

        function animateLoop() {
            let hasChanges = false;
            const easeFactor = 0.15; 

            state.forEach(item => {
                const diff = item.targetVal - item.currentVal;
                if (Math.abs(diff) < 0.01) {
                    item.currentVal = item.targetVal;
                } else {
                    item.currentVal += diff * easeFactor;
                    hasChanges = true;
                }
            });

            renderChart();
            updateStats();
            
            if (gameMode === 'challenge' && !hasChanges) {
                checkWinCondition();
            }

            if (hasChanges) {
                requestAnimationFrame(animateLoop);
            } else {
                isAnimating = false;
            }
        }

        function checkWinCondition() {
            if (isWin) return;

            const total = state.reduce((sum, item) => sum + item.currentVal, 0);
            if (total === 0) return;

            let allMatch = true;
            state.forEach(item => {
                if (item.name === 'âˆ… æ— ') return;
                const userRatio = item.currentVal / total;
                const targetObj = challengeTarget.find(t => t.id === item.id);
                // å®¹å·® 1.5%
                if (Math.abs(userRatio - targetObj.ratio) > 0.015) {
                    allMatch = false;
                }
            });

            if (allMatch) {
                isWin = true;
                fireConfetti();
                setTimeout(() => {
                    document.getElementById('win-modal').classList.remove('hidden');
                }, 500);
            }
        }

        function updateStats() {
            const total = state.reduce((sum, item) => sum + item.currentVal, 0);
            document.getElementById('total-display').textContent = Math.round(state.reduce((sum, item) => sum + item.targetVal, 0));

            state.forEach(item => {
                const percent = total === 0 ? 0 : (item.currentVal / total * 100);
                
                if (gameMode === 'free') {
                    const el = document.getElementById(`percent-${item.id}`);
                    if(el) el.textContent = Math.round(percent) + '%';
                }
                
                const bar = document.getElementById(`bar-${item.id}`);
                if(bar) bar.style.width = percent + '%';
            });
        }

        // --- 6. ç»˜å›¾é€»è¾‘ ---

        function drawGhostChart() {
            const group = document.getElementById('ghost-layer');
            group.innerHTML = '';
            
            if (gameMode !== 'challenge') return;

            let cumulativeAngle = 0;
            const radius = 225; 

            challengeTarget.forEach(target => {
                if (target.ratio <= 0.01) return; 

                const sliceAngle = target.ratio * 360;
                const startAngle = cumulativeAngle;
                const endAngle = cumulativeAngle + sliceAngle;
                
                const pathData = describeArc(0, 0, radius, startAngle, endAngle);
                const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
                pathEl.setAttribute("d", pathData);
                pathEl.setAttribute("class", "ghost-sector");
                pathEl.setAttribute("stroke", "#f8fafc"); 
                group.appendChild(pathEl);

                // ç›®æ ‡æ ‡ç­¾
                const labelAngle = startAngle + sliceAngle / 2;
                const labelPos = polarToCartesian(0, 0, radius + 30, labelAngle);
                
                const textEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
                textEl.setAttribute("x", labelPos.x);
                textEl.setAttribute("y", labelPos.y);
                textEl.setAttribute("class", "ghost-label");
                
                // > 4% æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼Œé¿å…é‡å 
                if (target.ratio > 0.04) {
                    textEl.textContent = "ç›®æ ‡: " + Math.round(target.ratio * 100) + "%";
                    group.appendChild(textEl);
                }

                cumulativeAngle += sliceAngle;
            });
        }

        function renderChart() {
            const pathsGroup = document.getElementById('chart-paths');
            const labelsGroup = document.getElementById('chart-labels');
            
            pathsGroup.innerHTML = '';
            labelsGroup.innerHTML = '';

            const total = state.reduce((sum, item) => sum + item.currentVal, 0);
            let cumulativeAngle = 0;

            if (total === 0) {
                pathsGroup.innerHTML = `<circle cx="0" cy="0" r="200" fill="#f1f5f9" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="5,5"/>`;
                if(gameMode === 'free') {
                    pathsGroup.innerHTML += `<text x="0" y="0" text-anchor="middle" dominant-baseline="middle" fill="#94a3b8" font-size="16">æš‚æ— æ•°æ®</text>`;
                }
                return;
            }

            state.forEach(item => {
                if (item.currentVal <= 0.1) return;

                const sliceAngle = (item.currentVal / total) * 360;
                const startAngle = cumulativeAngle;
                const endAngle = cumulativeAngle + sliceAngle;
                const radius = 200;

                const pathData = describeArc(0, 0, radius, startAngle, endAngle);
                const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
                pathEl.setAttribute("d", pathData);
                pathEl.setAttribute("fill", item.color);
                pathEl.setAttribute("class", "sector");

                const midAngleRad = (startAngle + sliceAngle / 2 - 90) * Math.PI / 180;
                const hoverDist = 15;
                const transX = Math.cos(midAngleRad) * hoverDist;
                const transY = Math.sin(midAngleRad) * hoverDist;

                pathEl.addEventListener('mouseenter', function() {
                    this.style.transform = `translate(${transX}px, ${transY}px)`;
                });
                pathEl.addEventListener('mouseleave', function() {
                    this.style.transform = `translate(0px, 0px)`;
                });

                pathsGroup.appendChild(pathEl);

                if (sliceAngle > 15) {
                    const labelRadius = radius * 0.65;
                    const labelAngle = startAngle + sliceAngle / 2;
                    const labelPos = polarToCartesian(0, 0, labelRadius, labelAngle);

                    const textEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    textEl.setAttribute("x", labelPos.x);
                    textEl.setAttribute("y", labelPos.y);
                    textEl.setAttribute("class", "label");
                    
                    const tspanName = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                    tspanName.textContent = item.name.includes(' ') ? item.name.split(' ')[1] : item.name;
                    tspanName.setAttribute("x", labelPos.x);
                    tspanName.setAttribute("dy", gameMode === 'free' ? "-0.4em" : "0.3em");
                    
                    textEl.appendChild(tspanName);

                    if (gameMode === 'free') {
                        const percentText = Math.round((item.currentVal / total) * 100) + '%';
                        const tspanPercent = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                        tspanPercent.textContent = percentText;
                        tspanPercent.setAttribute("x", labelPos.x);
                        tspanPercent.setAttribute("dy", "1.2em");
                        tspanPercent.setAttribute("font-size", "12px");
                        tspanPercent.setAttribute("opacity", "0.9");
                        textEl.appendChild(tspanPercent);
                    }

                    labelsGroup.appendChild(textEl);
                }

                cumulativeAngle += sliceAngle;
            });
        }

        // --- 7. æ•°å­¦å·¥å…· ---

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function describeArc(x, y, radius, startAngle, endAngle) {
            if (endAngle - startAngle >= 360) {
                 return [
                    "M", x, y - radius,
                    "A", radius, radius, 0, 1, 1, x, y + radius,
                    "A", radius, radius, 0, 1, 1, x, y - radius,
                    "Z"
                ].join(" ");
            }

            const start = polarToCartesian(x, y, radius, endAngle);
            const end = polarToCartesian(x, y, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

            return [
                "M", x, y,
                "L", start.x, start.y,
                "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                "Z"
            ].join(" ");
        }

        // --- 8. ç¤¼èŠ±ç‰¹æ•ˆ ---
        
        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const particleCount = 150;

            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    size: Math.random() * 8 + 4,
                    color: ['#FF8080', '#87CEFA', '#76E0AD', '#FCD34D', '#A78BFA'][Math.floor(Math.random() * 5)],
                    life: 100,
                    gravity: 0.2
                });
            }

            function updateConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if (p.life > 0) {
                        active = true;
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += p.gravity;
                        p.life--;
                        p.size *= 0.96;
                        ctx.fillStyle = p.color;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
                if (active) requestAnimationFrame(updateConfetti);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            updateConfetti();
        }

        window.addEventListener('resize', () => {
             const canvas = document.getElementById('confetti-canvas');
             canvas.width = window.innerWidth;
             canvas.height = window.innerHeight;
        });

        // å¯åŠ¨
        initApp();

    </script>
</body>
</html>