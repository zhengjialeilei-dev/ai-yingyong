/**
 * 拼音搜索工具
 * - 支持汉字转拼音首字母
 * - 支持模糊匹配
 * - 支持搜索高亮
 */

// 简化版拼音首字母映射（覆盖常用汉字）
const PINYIN_DICT: { [key: string]: string } = {
  '一': 'y', '七': 'q', '三': 's', '上': 's', '下': 'x', '不': 'b', '与': 'y',
  '世': 's', '业': 'y', '东': 'd', '丝': 's', '两': 'l', '个': 'g', '中': 'z',
  '为': 'w', '主': 'z', '么': 'm', '之': 'z', '乎': 'h', '乐': 'l', '九': 'j',
  '也': 'y', '习': 'x', '书': 's', '买': 'm', '了': 'l', '二': 'e', '于': 'y',
  '五': 'w', '亚': 'y', '交': 'j', '亦': 'y', '产': 'c', '京': 'j', '人': 'r',
  '什': 's', '今': 'j', '介': 'j', '从': 'c', '他': 't', '代': 'd', '以': 'y',
  '们': 'm', '件': 'j', '价': 'j', '份': 'f', '企': 'q', '休': 'x', '会': 'h',
  '传': 'c', '位': 'w', '住': 'z', '体': 't', '何': 'h', '作': 'z', '你': 'n',
  '使': 's', '例': 'l', '供': 'g', '依': 'y', '便': 'b', '保': 'b', '信': 'x',
  '修': 'x', '倍': 'b', '做': 'z', '像': 'x', '儿': 'e', '元': 'y', '先': 'x',
  '光': 'g', '克': 'k', '入': 'r', '全': 'q', '八': 'b', '公': 'g', '六': 'l',
  '共': 'g', '关': 'g', '其': 'q', '具': 'j', '内': 'n', '再': 'z', '写': 'x',
  '军': 'j', '农': 'n', '冬': 'd', '冰': 'b', '决': 'j', '况': 'k', '准': 'z',
  '几': 'j', '出': 'c', '分': 'f', '切': 'q', '划': 'h', '列': 'l', '则': 'z',
  '创': 'c', '初': 'c', '利': 'l', '别': 'b', '到': 'd', '制': 'z', '刻': 'k',
  '前': 'q', '剑': 'j', '力': 'l', '功': 'g', '加': 'j', '务': 'w', '动': 'd',
  '助': 'z', '努': 'n', '劳': 'l', '势': 's', '包': 'b', '化': 'h', '北': 'b',
  '区': 'q', '十': 's', '千': 'q', '升': 's', '午': 'w', '半': 'b', '华': 'h',
  '单': 'd', '南': 'n', '卡': 'k', '印': 'y', '危': 'w', '即': 'j', '却': 'q',
  '历': 'l', '原': 'y', '去': 'q', '参': 'c', '又': 'y', '及': 'j', '友': 'y',
  '双': 's', '反': 'f', '发': 'f', '取': 'q', '受': 's', '变': 'b', '口': 'k',
  '古': 'g', '句': 'j', '另': 'l', '只': 'z', '叫': 'j', '可': 'k', '台': 't',
  '史': 's', '右': 'y', '叶': 'y', '号': 'h', '司': 's', '各': 'g', '合': 'h',
  '同': 't', '名': 'm', '后': 'h', '向': 'x', '吗': 'm', '否': 'f', '听': 't',
  '吧': 'b', '告': 'g', '员': 'y', '周': 'z', '味': 'w', '呢': 'n', '命': 'm',
  '和': 'h', '品': 'p', '哪': 'n', '唯': 'w', '商': 's', '善': 's', '喜': 'x',
  '器': 'q', '四': 's', '回': 'h', '因': 'y', '团': 't', '园': 'y', '困': 'k',
  '围': 'w', '图': 't', '国': 'g', '土': 't', '在': 'z', '地': 'd', '场': 'c',
  '坚': 'j', '型': 'x', '城': 'c', '域': 'y', '基': 'j', '堂': 't', '境': 'j',
  '增': 'z', '士': 's', '声': 's', '处': 'c', '备': 'b', '复': 'f', '外': 'w',
  '多': 'd', '夜': 'y', '大': 'd', '天': 't', '太': 't', '夫': 'f', '央': 'y',
  '失': 's', '头': 't', '夸': 'k', '奇': 'q', '奋': 'f', '奖': 'j', '套': 't',
  '女': 'n', '好': 'h', '如': 'r', '始': 's', '委': 'w', '威': 'w', '娱': 'y',
  '子': 'z', '字': 'z', '存': 'c', '孙': 's', '学': 'x', '孩': 'h', '安': 'a',
  '完': 'w', '宏': 'h', '官': 'g', '定': 'd', '实': 's', '室': 's', '宝': 'b',
  '客': 'k', '宣': 'x', '害': 'h', '家': 'j', '容': 'r', '密': 'm', '富': 'f',
  '寒': 'h', '察': 'c', '寻': 'x', '导': 'd', '封': 'f', '射': 's', '将': 'j',
  '小': 'x', '少': 's', '尔': 'e', '尚': 's', '就': 'j', '尺': 'c', '层': 'c',
  '居': 'j', '届': 'j', '展': 'z', '属': 's', '山': 's', '岁': 's', '岛': 'd',
  '岸': 'a', '峰': 'f', '崇': 'c', '川': 'c', '州': 'z', '工': 'g', '左': 'z',
  '巧': 'q', '巨': 'j', '差': 'c', '己': 'j', '已': 'y', '市': 's', '布': 'b',
  '师': 's', '希': 'x', '带': 'd', '帮': 'b', '常': 'c', '幕': 'm', '干': 'g',
  '平': 'p', '年': 'n', '并': 'b', '幸': 'x', '幻': 'h', '广': 'g', '庆': 'q',
  '床': 'c', '序': 'x', '库': 'k', '应': 'y', '底': 'd', '店': 'd', '度': 'd',
  '座': 'z', '康': 'k', '延': 'y', '建': 'j', '开': 'k', '异': 'y', '弃': 'q',
  '弄': 'n', '式': 's', '引': 'y', '张': 'z', '强': 'q', '归': 'g', '当': 'd',
  '录': 'l', '形': 'x', '彩': 'c', '彰': 'z', '影': 'y', '往': 'w', '待': 'd',
  '很': 'h', '得': 'd', '御': 'y', '心': 'x', '必': 'b', '志': 'z', '忘': 'w',
  '忙': 'm', '快': 'k', '念': 'n', '忽': 'h', '怀': 'h', '态': 't', '怎': 'z',
  '思': 's', '急': 'j', '性': 'x', '怪': 'g', '总': 'z', '恋': 'l', '恐': 'k',
  '息': 'x', '您': 'n', '悟': 'w', '情': 'q', '惊': 'j', '想': 'x', '意': 'y',
  '感': 'g', '慢': 'm', '慧': 'h', '成': 'c', '我': 'w', '或': 'h', '战': 'z',
  '户': 'h', '房': 'f', '所': 's', '手': 's', '才': 'c', '打': 'd', '托': 't',
  '执': 'z', '找': 'z', '承': 'c', '把': 'b', '抓': 'z', '投': 't', '抗': 'k',
  '折': 'z', '报': 'b', '抱': 'b', '抵': 'd', '押': 'y', '拉': 'l', '拍': 'p',
  '拒': 'j', '拓': 't', '拜': 'b', '拟': 'n', '拥': 'y', '择': 'z', '括': 'k',
  '拿': 'n', '持': 'c', '指': 'z', '按': 'a', '挑': 't', '挥': 'h', '挺': 't',
  '捕': 'b', '换': 'h', '据': 'j', '探': 't', '接': 'j', '控': 'k', '推': 't',
  '描': 'm', '提': 't', '插': 'c', '握': 'w', '援': 'y', '损': 's', '摄': 's',
  '摆': 'b', '摘': 'z', '撑': 'c', '播': 'b', '操': 'c', '擎': 'q', '支': 'z',
  '收': 's', '改': 'g', '攻': 'g', '放': 'f', '政': 'z', '故': 'g', '效': 'x',
  '敌': 'd', '敏': 'm', '教': 'j', '散': 's', '敢': 'g', '数': 's', '整': 'z',
  '文': 'w', '斗': 'd', '斤': 'j', '新': 'x', '方': 'f', '施': 's', '旁': 'p',
  '旅': 'l', '旋': 'x', '族': 'z', '无': 'w', '既': 'j', '日': 'r', '旧': 'j',
  '早': 'z', '时': 's', '明': 'm', '易': 'y', '星': 'x', '映': 'y', '春': 'c',
  '是': 's', '显': 'x', '晚': 'w', '普': 'p', '景': 'j', '智': 'z', '暂': 'z',
  '暖': 'n', '暴': 'b', '曲': 'q', '更': 'g', '曾': 'c', '替': 't', '最': 'z',
  '月': 'y', '有': 'y', '服': 'f', '望': 'w', '朝': 'c', '期': 'q', '木': 'm',
  '未': 'w', '本': 'b', '术': 's', '朱': 'z', '机': 'j', '杀': 's', '权': 'q',
  '李': 'l', '村': 'c', '杨': 'y', '束': 's', '条': 't', '来': 'l', '杯': 'b',
  '板': 'b', '极': 'j', '构': 'g', '析': 'x', '林': 'l', '果': 'g',
  '枪': 'q', '柔': 'r', '查': 'c', '标': 'b', '栏': 'l', '校': 'x', '样': 'y',
  '核': 'h', '根': 'g', '格': 'g', '案': 'a', '桌': 'z', '档': 'd', '桥': 'q',
  '梦': 'm', '检': 'j', '棋': 'q', '森': 's', '植': 'z', '椅': 'y', '楚': 'c',
  '楼': 'l', '概': 'g', '模': 'm', '横': 'h', '欢': 'h', '欣': 'x', '款': 'k',
  '歌': 'g', '止': 'z', '正': 'z', '此': 'c', '步': 'b', '武': 'w', '死': 's',
  '段': 'd', '每': 'm', '比': 'b', '毕': 'b', '毛': 'm', '民': 'm', '气': 'q',
  '水': 's', '永': 'y', '求': 'q', '汇': 'h', '江': 'j', '池': 'c', '没': 'm',
  '河': 'h', '油': 'y', '治': 'z', '法': 'f', '波': 'b', '注': 'z', '洋': 'y',
  '洗': 'x', '活': 'h', '流': 'l', '浅': 'q', '测': 'c', '浏': 'l', '海': 'h',
  '消': 'x', '深': 's', '混': 'h', '清': 'q', '港': 'g', '游': 'y', '湖': 'h',
  '源': 'y', '溪': 'x', '演': 'y', '满': 'm', '滑': 'h', '滚': 'g', '漂': 'p',
  '潜': 'q', '火': 'h', '灯': 'd', '灰': 'h', '灵': 'l', '炎': 'y',
  '炮': 'p', '点': 'd', '烈': 'l', '烟': 'y', '热': 'r', '焦': 'j', '然': 'r',
  '照': 'z', '熟': 's', '燃': 'r', '爆': 'b', '爱': 'a', '父': 'f', '片': 'p',
  '版': 'b', '牌': 'p', '牙': 'y', '物': 'w', '特': 't', '状': 'z', '独': 'd',
  '狗': 'g', '猛': 'm', '猜': 'c', '献': 'x', '玄': 'x', '率': 'l', '王': 'w',
  '玩': 'w', '环': 'h', '现': 'x', '玻': 'b', '珍': 'z', '班': 'b', '球': 'q',
  '理': 'l', '琴': 'q', '瑞': 'r', '甚': 's', '生': 's', '用': 'y', '由': 'y',
  '甲': 'j', '申': 's', '电': 'd', '男': 'n', '画': 'h', '界': 'j', '留': 'l',
  '略': 'l', '番': 'f', '疑': 'y', '病': 'b', '登': 'd', '白': 'b', '百': 'b',
  '的': 'd', '皇': 'h', '皮': 'p', '盖': 'g', '盘': 'p', '目': 'm', '直': 'z',
  '相': 'x', '省': 's', '看': 'k', '真': 'z', '眼': 'y', '着': 'z', '睛': 'j',
  '睡': 's', '知': 'z', '短': 'd', '石': 's', '研': 'y', '破': 'p', '础': 'c',
  '硬': 'y', '确': 'q', '碎': 's', '碗': 'w', '碰': 'p', '示': 's', '社': 's',
  '祝': 'z', '神': 's', '祥': 'x', '票': 'p', '离': 'l', '私': 's', '秋': 'q',
  '科': 'k', '秒': 'm', '秘': 'm', '租': 'z', '秩': 'z', '积': 'j', '称': 'c',
  '移': 'y', '程': 'c', '稀': 'x', '税': 's', '种': 'z', '稳': 'w', '空': 'k',
  '穿': 'c', '突': 't', '窗': 'c', '立': 'l', '站': 'z', '章': 'z', '童': 't',
  '端': 'd', '竞': 'j', '竟': 'j', '笑': 'x', '笔': 'b', '等': 'd', '筑': 'z',
  '答': 'd', '策': 'c', '简': 'j', '算': 's', '管': 'g', '箱': 'x', '篇': 'p',
  '类': 'l', '粉': 'f', '精': 'j', '系': 'x', '素': 's', '索': 's', '紧': 'j',
  '红': 'h', '约': 'y', '级': 'j', '纪': 'j', '纯': 'c', '纸': 'z', '纳': 'n',
  '纷': 'f', '线': 'x', '组': 'z', '细': 'x', '终': 'z', '经': 'j', '结': 'j',
  '绕': 'r', '给': 'g', '绝': 'j', '统': 't', '继': 'j', '绩': 'j', '绪': 'x',
  '续': 'x', '维': 'w', '综': 'z', '绿': 'l', '缓': 'h', '编': 'b', '缘': 'y',
  '网': 'w', '罗': 'l', '罚': 'f', '置': 'z', '署': 's', '羊': 'y', '美': 'm',
  '群': 'q', '义': 'y', '翻': 'f', '老': 'l', '考': 'k', '者': 'z',
  '而': 'e', '耐': 'n', '职': 'z', '联': 'l', '肉': 'r', '股': 'g', '肯': 'k',
  '育': 'y', '背': 'b', '胜': 's', '能': 'n', '脑': 'n', '脚': 'j', '脱': 't',
  '腿': 't', '自': 'z', '臭': 'c', '至': 'z', '致': 'z', '舍': 's', '舞': 'w',
  '航': 'h', '船': 'c', '良': 'l', '色': 's', '艺': 'y', '节': 'j', '花': 'h',
  '苏': 's', '苦': 'k', '英': 'y', '范': 'f', '茶': 'c', '草': 'c', '荒': 'h',
  '荣': 'r', '药': 'y', '菜': 'c', '营': 'y', '落': 'l', '著': 'z', '葛': 'g',
  '蒙': 'm', '蓝': 'l', '藏': 'c', '虑': 'l', '虚': 'x', '虽': 's', '蛇': 's',
  '蛋': 'd', '融': 'r', '血': 'x', '行': 'x', '街': 'j', '衡': 'h', '补': 'b',
  '表': 'b', '衬': 'c', '袋': 'd', '被': 'b', '裁': 'c', '装': 'z', '裤': 'k',
  '西': 'x', '要': 'y', '覆': 'f', '见': 'j', '观': 'g', '规': 'g', '视': 's',
  '览': 'l', '觉': 'j', '角': 'j', '解': 'j', '触': 'c', '言': 'y', '计': 'j',
  '订': 'd', '认': 'r', '让': 'r', '议': 'y', '记': 'j', '讲': 'j', '许': 'x',
  '论': 'l', '设': 's', '访': 'f', '证': 'z', '评': 'p', '识': 's', '诉': 's',
  '词': 'c', '译': 'y', '试': 's', '诗': 's', '话': 'h', '该': 'g', '详': 'x',
  '语': 'y', '误': 'w', '说': 's', '请': 'q', '诸': 'z', '读': 'd', '课': 'k',
  '谁': 's', '调': 'd', '谈': 't', '谢': 'x', '谱': 'p', '豆': 'd', '象': 'x',
  '豪': 'h', '贝': 'b', '负': 'f', '财': 'c', '责': 'z', '败': 'b', '货': 'h',
  '质': 'z', '贵': 'g', '费': 'f', '资': 'z', '赋': 'f', '赏': 's', '赛': 's',
  '赢': 'y', '赵': 'z', '起': 'q', '超': 'c', '越': 'y', '趋': 'q', '趣': 'q',
  '足': 'z', '跑': 'p', '路': 'l', '跟': 'g', '跳': 't', '踏': 't', '踢': 't',
  '身': 's', '车': 'c', '轮': 'l', '软': 'r', '转': 'z', '轻': 'q', '载': 'z',
  '较': 'j', '辑': 'j', '输': 's', '辛': 'x', '辨': 'b', '边': 'b', '达': 'd',
  '迅': 'x', '过': 'g', '迎': 'y', '运': 'y', '近': 'j', '返': 'f', '还': 'h',
  '这': 'z', '进': 'j', '远': 'y', '违': 'w', '连': 'l', '迟': 'c', '迪': 'd',
  '迫': 'p', '述': 's', '追': 'z', '退': 't', '送': 's', '适': 's', '逃': 't',
  '选': 'x', '逐': 'z', '透': 't', '通': 't', '速': 's', '造': 'z', '逻': 'l',
  '遇': 'y', '道': 'd', '遗': 'y', '那': 'n', '邀': 'y', '邮': 'y', '部': 'b',
  '都': 'd', '配': 'p', '酒': 'j', '酷': 'k', '里': 'l', '重': 'z', '量': 'l',
  '金': 'j', '针': 'z', '钟': 'z', '钢': 'g', '钱': 'q', '铁': 't', '铜': 't',
  '银': 'y', '销': 'x', '锁': 's', '锐': 'r', '错': 'c', '镇': 'z', '镜': 'j',
  '长': 'c', '门': 'm', '闪': 's', '闭': 'b', '问': 'w', '闲': 'x', '间': 'j',
  '闻': 'w', '阅': 'y', '防': 'f', '阳': 'y', '阴': 'y', '阵': 'z', '阶': 'j',
  '际': 'j', '陆': 'l', '院': 'y', '除': 'c', '险': 'x', '陪': 'p', '随': 's',
  '隐': 'y', '隔': 'g', '障': 'z', '难': 'n', '雄': 'x', '集': 'j', '雨': 'y',
  '雪': 'x', '零': 'l', '雷': 'l', '需': 'x', '震': 'z', '霸': 'b', '露': 'l',
  '青': 'q', '静': 'j', '非': 'f', '靠': 'k', '面': 'm', '革': 'g', '鞋': 'x',
  '音': 'y', '页': 'y', '顶': 'd', '项': 'x', '顺': 's', '须': 'x', '顿': 'd',
  '预': 'y', '领': 'l', '颗': 'k', '题': 't', '额': 'e', '颜': 'y', '风': 'f',
  '飞': 'f', '食': 's', '饭': 'f', '饮': 'y', '首': 's', '香': 'x', '马': 'm',
  '驱': 'q', '验': 'y', '骨': 'g', '高': 'g', '鬼': 'g', '鱼': 'y', '鲜': 'x',
  '鸟': 'n', '鸡': 'j', '鸭': 'y', '鹅': 'e', '麻': 'm', '黄': 'h', '黑': 'h',
  '默': 'm', '鼓': 'g', '鼠': 's', '齐': 'q', '齿': 'c', '龄': 'l', '龙': 'l',
  // 数学相关补充
  '圆': 'y', '宽': 'k', '径': 'j', '万': 'w', '亿': 'y', '减': 'j', '乘': 'c',
  '余': 'y', '偶': 'o', '扇': 's', '柱': 'z', '锥': 'z', '棱': 'l', '轴': 'z',
  '浓': 'n', '博': 'b', '饼': 'b', '互': 'h',
};

/**
 * 获取汉字的拼音首字母
 */
export const getFirstLetter = (char: string): string => {
  if (!char) return '';
  
  // 英文字母直接返回小写
  if (/[a-zA-Z]/.test(char)) {
    return char.toLowerCase();
  }
  
  // 数字直接返回
  if (/[0-9]/.test(char)) {
    return char;
  }
  
  // 查找拼音首字母
  return PINYIN_DICT[char] || '';
};

/**
 * 获取字符串的拼音首字母组合
 */
export const getPinyinInitials = (str: string): string => {
  if (!str) return '';
  return Array.from(str).map(getFirstLetter).join('');
};

/**
 * 检查是否匹配（支持拼音首字母、全文、模糊匹配）
 */
export const matchSearch = (
  text: string,
  query: string
): { matched: boolean; score: number } => {
  if (!query || !text) return { matched: !query, score: 0 };
  
  const lowerText = text.toLowerCase();
  const lowerQuery = query.toLowerCase();
  
  // 1. 完全匹配（最高分）
  if (lowerText === lowerQuery) {
    return { matched: true, score: 100 };
  }
  
  // 2. 包含匹配（高分）
  if (lowerText.includes(lowerQuery)) {
    return { matched: true, score: 80 };
  }
  
  // 3. 拼音首字母匹配
  const initials = getPinyinInitials(text);
  if (initials.includes(lowerQuery)) {
    return { matched: true, score: 60 };
  }
  
  // 4. 模糊匹配（查询的每个字符都出现在文本中，且顺序正确）
  let textIndex = 0;
  let matchCount = 0;
  for (const char of lowerQuery) {
    const foundIndex = lowerText.indexOf(char, textIndex);
    if (foundIndex !== -1) {
      matchCount++;
      textIndex = foundIndex + 1;
    }
  }
  
  if (matchCount === lowerQuery.length) {
    return { matched: true, score: 40 };
  }
  
  // 5. 部分字符匹配（低分）
  if (matchCount > lowerQuery.length * 0.6) {
    return { matched: true, score: 20 };
  }
  
  return { matched: false, score: 0 };
};

/**
 * 高亮匹配的文本
 */
export const highlightMatch = (
  text: string,
  query: string
): { text: string; highlighted: boolean }[] => {
  if (!query || !text) return [{ text, highlighted: false }];
  
  const lowerText = text.toLowerCase();
  const lowerQuery = query.toLowerCase();
  const result: { text: string; highlighted: boolean }[] = [];
  
  // 尝试直接匹配
  const index = lowerText.indexOf(lowerQuery);
  if (index !== -1) {
    if (index > 0) {
      result.push({ text: text.slice(0, index), highlighted: false });
    }
    result.push({ text: text.slice(index, index + query.length), highlighted: true });
    if (index + query.length < text.length) {
      result.push({ text: text.slice(index + query.length), highlighted: false });
    }
    return result;
  }
  
  // 尝试拼音首字母匹配 - 高亮对应的汉字
  const initials = getPinyinInitials(text);
  const initialIndex = initials.indexOf(lowerQuery);
  if (initialIndex !== -1) {
    if (initialIndex > 0) {
      result.push({ text: text.slice(0, initialIndex), highlighted: false });
    }
    result.push({ text: text.slice(initialIndex, initialIndex + query.length), highlighted: true });
    if (initialIndex + query.length < text.length) {
      result.push({ text: text.slice(initialIndex + query.length), highlighted: false });
    }
    return result;
  }
  
  // 无法高亮，返回原文
  return [{ text, highlighted: false }];
};

// ============ 搜索历史管理 ============

const SEARCH_HISTORY_KEY = 'mathflow_search_history';
const MAX_HISTORY_ITEMS = 10;

/**
 * 获取搜索历史
 */
export const getSearchHistory = (): string[] => {
  try {
    const history = localStorage.getItem(SEARCH_HISTORY_KEY);
    return history ? JSON.parse(history) : [];
  } catch {
    return [];
  }
};

/**
 * 添加搜索历史
 */
export const addSearchHistory = (query: string): void => {
  if (!query.trim()) return;
  
  try {
    let history = getSearchHistory();
    // 移除重复项
    history = history.filter(item => item !== query);
    // 添加到开头
    history.unshift(query);
    // 限制数量
    history = history.slice(0, MAX_HISTORY_ITEMS);
    localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
  } catch {
    // 忽略 localStorage 错误
  }
};

/**
 * 清除搜索历史
 */
export const clearSearchHistory = (): void => {
  try {
    localStorage.removeItem(SEARCH_HISTORY_KEY);
  } catch {
    // 忽略错误
  }
};

/**
 * 删除单条搜索历史
 */
export const removeSearchHistoryItem = (query: string): void => {
  try {
    let history = getSearchHistory();
    history = history.filter(item => item !== query);
    localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
  } catch {
    // 忽略错误
  }
};
